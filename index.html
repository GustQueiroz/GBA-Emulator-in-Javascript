<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="Game Boy Advance Emulator - Play GBA games in your browser">
<meta name="theme-color" content="#667eea">
<title>GBN</title>
<link rel="stylesheet" href="resources/main.css">
<link rel="stylesheet" href="style.css">
<script src="js/util.js"></script>
<script src="js/core.js"></script>
<script src="js/arm.js"></script>
<script src="js/thumb.js"></script>
<script src="js/mmu.js"></script>
<script src="js/io.js"></script>
<script src="js/audio.js"></script>
<script src="js/video.js"></script>
<script src="js/video/proxy.js"></script>
<script src="js/video/software.js"></script>
<script src="js/irq.js"></script>
<script src="js/keypad.js"></script>
<script src="js/sio.js"></script>
<script src="js/savedata.js"></script>
<script src="js/gpio.js"></script>
<script src="js/gba.js"></script>
<script src="resources/xhr.js"></script>

<script>
var gba;
var runCommands = [];
var debug = null;

var perfMonitor = {
	startTime: null,
	sessionTime: 0,
	lastFPS: 0,
	memoryUsed: 0,
	timerInterval: null
};

var speedControl = {
	currentSpeed: 1,
	turboSpeed: 20,
	turboActive: false,
	previousSpeed: 1,
	baseThrottle: 16.67,
	minThrottle: 4,
	framesPerIteration: 1
};

var themeManager = {
	currentTheme: 'dark',
	currentLayout: 'default',
	customBackground: null
};

var controlRemapping = {
	listening: false,
	currentAction: null,
	currentElement: null,
	defaultMapping: {
		UP: 38,
		DOWN: 40,
		LEFT: 37,
		RIGHT: 39,
		A: 88,
		B: 90,
		L: 65,
		R: 83,
		START: 13,
		SELECT: 220
	},
	keyNames: {
		8: 'Backspace',
		9: 'Tab',
		13: 'Enter',
		16: 'Shift',
		17: 'Ctrl',
		18: 'Alt',
		20: 'CapsLock',
		27: 'Esc',
		32: 'Space',
		37: '←',
		38: '↑',
		39: '→',
		40: '↓',
		46: 'Delete',
		220: '\\'
	}
};

try {
	gba = new GameBoyAdvance();
	gba.keypad.eatInput = true;
	gba.setLogger(function(level, error) {
		console.log(error);
		gba.pause();
		var screen = document.getElementById('screen');
		if (screen.getAttribute('class') == 'dead') {
			console.log('We appear to have crashed multiple times without reseting.');
			return;
		}
		var crash = document.createElement('img');
		crash.setAttribute('id', 'crash');
		crash.setAttribute('src', 'resources/crash.png');
		screen.parentElement.insertBefore(crash, screen);
		screen.setAttribute('class', 'dead');
	});
	
	gba.reportFPS = function(fps) {
		perfMonitor.lastFPS = Math.round(fps);
		updatePerformanceMonitor();
	};
	
	var originalAdvanceFrame = gba.advanceFrame.bind(gba);
	gba.advanceFrame = function() {
		for (var i = 0; i < speedControl.framesPerIteration; i++) {
			originalAdvanceFrame();
		}
	};
} catch (exception) {
	gba = null;
}

window.onload = function() {
	if (gba && FileReader) {
		var canvas = document.getElementById('screen');
		gba.setCanvas(canvas);

		gba.logLevel = gba.LOG_ERROR;

		loadRom('resources/bios.bin', function(bios) {
			gba.setBios(bios);
		});

		if (!gba.audio.context) {
			var soundbox = document.getElementById('sound');
			soundbox.parentElement.removeChild(soundbox);
		}

		if (window.navigator.appName == 'Microsoft Internet Explorer') {
			var pixelatedBox = document.getElementById('pixelated');
			pixelatedBox.parentElement.removeChild(pixelatedBox);
		}
		
		loadControlMappings();
		loadSpeedPreference();
		loadCustomization();
		
		window.addEventListener('keydown', handleTurboKey, true);
		window.addEventListener('keyup', handleTurboKey, true);
	} else {
		var dead = document.getElementById('controls');
		dead.parentElement.removeChild(dead);
	}
}

function fadeOut(id, nextId, kill) {
	var e = document.getElementById(id);
	var e2 = document.getElementById(nextId);
	if (!e) {
		return;
	}
	var removeSelf = function() {
		if (kill) {
			e.parentElement.removeChild(e);
		} else {
			e.setAttribute('class', 'dead');
			e.removeEventListener('webkitTransitionEnd', removeSelf);
			e.removeEventListener('oTransitionEnd', removeSelf);
			e.removeEventListener('transitionend', removeSelf);
		}
		if (e2) {
			e2.setAttribute('class', 'hidden');
			setTimeout(function() {
				e2.removeAttribute('class');
			}, 0);
		}
	}

	e.addEventListener('webkitTransitionEnd', removeSelf, false);
	e.addEventListener('oTransitionEnd', removeSelf, false);
	e.addEventListener('transitionend', removeSelf, false);
	e.setAttribute('class', 'hidden');
}

function run(file) {
	var dead = document.getElementById('loader');
	dead.value = '';
	var load = document.getElementById('select');
	load.textContent = 'Loading...';
	load.classList.add('loading');
	load.removeAttribute('onclick');
	var pause = document.getElementById('pause');
	pause.textContent = "PAUSE";
	gba.loadRomFromFile(file, function(result) {
		load.classList.remove('loading');
		if (result) {
			for (var i = 0; i < runCommands.length; ++i) {
				runCommands[i]();
			}
			runCommands = [];
			fadeOut('preload', 'ingame');
			startSessionTimer();
			gba.runStable();
		} else {
			load.textContent = 'FAILED';
			setTimeout(function() {
				load.textContent = 'Select ROM';
				load.onclick = function() {
					document.getElementById('loader').click();
				}
			}, 3000);
		}
	});
}

function reset() {
	gba.pause();
	gba.reset();
	stopSessionTimer();
	resetPerformanceMonitor();
	var load = document.getElementById('select');
	load.textContent = 'Select ROM';
	var crash = document.getElementById('crash');
	if (crash) {
		var context = gba.targetCanvas.getContext('2d');
		context.clearRect(0, 0, 480, 320);
		gba.video.drawCallback();
		crash.parentElement.removeChild(crash);
		var canvas = document.getElementById('screen');
		canvas.removeAttribute('class');
	} else {
		lcdFade(gba.context, gba.targetCanvas.getContext('2d'), gba.video.drawCallback);
	}
	load.onclick = function() {
		document.getElementById('loader').click();
	}
	fadeOut('ingame', 'preload');
}

function uploadSavedataPending(file) {
	runCommands.push(function() { gba.loadSavedataFromFile(file) });
}

function togglePause() {
	var e = document.getElementById('pause');
	if (gba.paused) {
		if (debug && debug.gbaCon) {
			debug.gbaCon.run();
		} else {
			gba.runStable();
		}
		e.textContent = "PAUSE";
	} else {
		if (debug && debug.gbaCon) {
			debug.gbaCon.pause();
		} else {
			gba.pause();
		}
		e.textContent = "PLAY";
	}
}

function screenshot() {
	var canvas = gba.indirectCanvas;
	window.open(canvas.toDataURL('image/png'), 'screenshot');
}

function updatePerformanceMonitor() {
	var fpsElement = document.getElementById('fps-value');
	if (fpsElement) {
		fpsElement.textContent = perfMonitor.lastFPS || '--';
		fpsElement.className = 'perf-value';
		if (perfMonitor.lastFPS >= 58) {
			fpsElement.classList.add('good');
		} else if (perfMonitor.lastFPS >= 45) {
			fpsElement.classList.add('warning');
		} else if (perfMonitor.lastFPS > 0) {
			fpsElement.classList.add('bad');
		}
	}
	
	var speedElement = document.getElementById('speed-value');
	if (speedElement && perfMonitor.lastFPS > 0) {
		var speed = Math.round((perfMonitor.lastFPS / 60) * 100);
		speedElement.textContent = speed + '%';
		speedElement.className = 'perf-value';
		if (speed >= 95) {
			speedElement.classList.add('good');
		} else if (speed >= 80) {
			speedElement.classList.add('warning');
		} else {
			speedElement.classList.add('bad');
		}
	}
	
	var memoryElement = document.getElementById('memory-value');
	if (memoryElement) {
		if (performance.memory) {
			var usedMB = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
			memoryElement.textContent = usedMB + ' MB';
		} else {
			memoryElement.textContent = 'N/A';
		}
	}
}

function startSessionTimer() {
	perfMonitor.startTime = Date.now();
	perfMonitor.sessionTime = 0;
	
	if (perfMonitor.timerInterval) {
		clearInterval(perfMonitor.timerInterval);
	}
	
	perfMonitor.timerInterval = setInterval(function() {
		if (!gba.paused) {
			perfMonitor.sessionTime = Math.floor((Date.now() - perfMonitor.startTime) / 1000);
			updateSessionTime();
			
			var memoryElement = document.getElementById('memory-value');
			if (memoryElement) {
				if (performance.memory) {
					var usedMB = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
					memoryElement.textContent = usedMB + ' MB';
				} else {
					memoryElement.textContent = 'N/A';
				}
			}
		}
	}, 1000);
}

function stopSessionTimer() {
	if (perfMonitor.timerInterval) {
		clearInterval(perfMonitor.timerInterval);
		perfMonitor.timerInterval = null;
	}
}

function updateSessionTime() {
	var timeElement = document.getElementById('time-value');
	if (timeElement) {
		var hours = Math.floor(perfMonitor.sessionTime / 3600);
		var minutes = Math.floor((perfMonitor.sessionTime % 3600) / 60);
		var seconds = perfMonitor.sessionTime % 60;
		
		var pad = function(num) {
			return (num < 10 ? '0' : '') + num;
		};
		
		timeElement.textContent = pad(hours) + ':' + pad(minutes) + ':' + pad(seconds);
	}
}

function resetPerformanceMonitor() {
	perfMonitor.lastFPS = 0;
	perfMonitor.sessionTime = 0;
	
	document.getElementById('fps-value').textContent = '--';
	document.getElementById('speed-value').textContent = '--';
	document.getElementById('memory-value').textContent = '--';
	document.getElementById('time-value').textContent = '00:00:00';
	
	document.getElementById('fps-value').className = 'perf-value';
	document.getElementById('speed-value').className = 'perf-value';
}

function getKeyName(keyCode) {
	if (controlRemapping.keyNames[keyCode]) {
		return controlRemapping.keyNames[keyCode];
	}
	if (keyCode >= 65 && keyCode <= 90) {
		return String.fromCharCode(keyCode);
	}
	if (keyCode >= 48 && keyCode <= 57) {
		return String.fromCharCode(keyCode);
	}
	return 'Key' + keyCode;
}

function remapControl(element) {
	if (controlRemapping.listening) {
		cancelRemap();
	}
	
	controlRemapping.listening = true;
	controlRemapping.currentAction = element.getAttribute('data-action');
	controlRemapping.currentElement = element;
	
	element.classList.add('listening');
	var keyElement = element.querySelector('.control-key');
	var hintElement = element.querySelector('.control-hint');
	
	keyElement.textContent = '...';
	hintElement.textContent = 'Press any key';
	
	document.addEventListener('keydown', handleRemapKeyPress, true);
}

function handleRemapKeyPress(e) {
	if (!controlRemapping.listening) return;
	
	e.preventDefault();
	e.stopPropagation();
	
	if (e.keyCode === 27) {
		var keyElement = controlRemapping.currentElement.querySelector('.control-key');
		var action = controlRemapping.currentAction;
		var currentKeyCode = gba.keypad['KEYCODE_' + action];
		keyElement.textContent = getKeyName(currentKeyCode);
		cancelRemap();
		return;
	}
	
	var action = controlRemapping.currentAction;
	var keyCode = e.keyCode;
	
	gba.keypad['KEYCODE_' + action] = keyCode;
	
	var keyElement = controlRemapping.currentElement.querySelector('.control-key');
	keyElement.textContent = getKeyName(keyCode);

	saveControlMapping(action, keyCode);
	
	cancelRemap();
}

function cancelRemap() {
	if (controlRemapping.currentElement) {
		controlRemapping.currentElement.classList.remove('listening');
		var hintElement = controlRemapping.currentElement.querySelector('.control-hint');
		hintElement.textContent = 'Click to change';
	}
	
	controlRemapping.listening = false;
	controlRemapping.currentAction = null;
	controlRemapping.currentElement = null;
	
	document.removeEventListener('keydown', handleRemapKeyPress, true);
}

function saveControlMapping(action, keyCode) {
	var mappings = JSON.parse(localStorage.getItem('gbaControlMappings') || '{}');
	mappings[action] = keyCode;
	localStorage.setItem('gbaControlMappings', JSON.stringify(mappings));
}

function loadControlMappings() {
	var mappings = JSON.parse(localStorage.getItem('gbaControlMappings') || '{}');
	
	for (var action in mappings) {
		var keyCode = mappings[action];
		gba.keypad['KEYCODE_' + action] = keyCode;
		
		var keyElement = document.getElementById('key-' + action);
		if (keyElement) {
			keyElement.textContent = getKeyName(keyCode);
		}
	}
}

function resetControlsToDefault() {
	if (!confirm('Reset all controls to default settings?')) {
		return;
	}
	
	localStorage.removeItem('gbaControlMappings');
	
	for (var action in controlRemapping.defaultMapping) {
		var keyCode = controlRemapping.defaultMapping[action];
		gba.keypad['KEYCODE_' + action] = keyCode;
		
		var keyElement = document.getElementById('key-' + action);
		if (keyElement) {
			keyElement.textContent = getKeyName(keyCode);
		}
	}
	
	cancelRemap();
}

function toggleFullscreen() {
	var container = document.getElementById('screen-container');
	
	if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
		if (container.requestFullscreen) {
			container.requestFullscreen();
		} else if (container.webkitRequestFullscreen) {
			container.webkitRequestFullscreen();
		} else if (container.mozRequestFullScreen) {
			container.mozRequestFullScreen();
		}
	} else {
		if (document.exitFullscreen) {
			document.exitFullscreen();
		} else if (document.webkitExitFullscreen) {
			document.webkitExitFullscreen();
		} else if (document.mozCancelFullScreen) {
			document.mozCancelFullScreen();
		}
	}
}

function applyTheme(themeName) {
	themeManager.currentTheme = themeName;
	document.body.setAttribute('data-theme', themeName);
	localStorage.setItem('gbaTheme', themeName);
	updateThemeUI();
}

function applyLayout(layoutName) {
	themeManager.currentLayout = layoutName;
	document.body.setAttribute('data-layout', layoutName);
	localStorage.setItem('gbaLayout', layoutName);
	updateLayoutUI();
}

function updateThemeUI() {
	var themeButtons = document.querySelectorAll('.theme-btn');
	themeButtons.forEach(function(btn) {
		var btnTheme = btn.getAttribute('data-theme');
		if (btnTheme === themeManager.currentTheme) {
			btn.classList.add('active');
		} else {
			btn.classList.remove('active');
		}
	});
}

function updateLayoutUI() {
	var layoutButtons = document.querySelectorAll('.layout-btn');
	layoutButtons.forEach(function(btn) {
		var btnLayout = btn.getAttribute('data-layout');
		if (btnLayout === themeManager.currentLayout) {
			btn.classList.add('active');
		} else {
			btn.classList.remove('active');
		}
	});
}

function uploadBackground() {
	var input = document.createElement('input');
	input.type = 'file';
	input.accept = 'image/*';
	input.onchange = function(e) {
		var file = e.target.files[0];
		if (file) {
			var reader = new FileReader();
			reader.onload = function(evt) {
				themeManager.customBackground = evt.target.result;
				document.body.style.backgroundImage = 'url(' + evt.target.result + ')';
				document.body.style.backgroundSize = 'cover';
				document.body.style.backgroundAttachment = 'fixed';
				localStorage.setItem('gbaCustomBg', evt.target.result);
			};
			reader.readAsDataURL(file);
		}
	};
	input.click();
}

function clearBackground() {
	themeManager.customBackground = null;
	document.body.style.backgroundImage = '';
	localStorage.removeItem('gbaCustomBg');
}

function loadCustomization() {
	var savedTheme = localStorage.getItem('gbaTheme');
	if (savedTheme) {
		applyTheme(savedTheme);
	} else {
		applyTheme('dark');
	}
	
	var savedLayout = localStorage.getItem('gbaLayout');
	if (savedLayout) {
		applyLayout(savedLayout);
	}
	
	var savedBg = localStorage.getItem('gbaCustomBg');
	if (savedBg) {
		themeManager.customBackground = savedBg;
		document.body.style.backgroundImage = 'url(' + savedBg + ')';
		document.body.style.backgroundSize = 'cover';
		document.body.style.backgroundAttachment = 'fixed';
	}
}

function setGameSpeed(speed) {
	speedControl.currentSpeed = speed;
	speedControl.previousSpeed = speed;
	updateThrottle();
	updateSpeedUI();
	saveSpeedPreference();
}

function updateThrottle() {
	var activeSpeed = speedControl.turboActive ? speedControl.turboSpeed : speedControl.currentSpeed;
	var targetThrottle = speedControl.baseThrottle / activeSpeed;
	
	if (targetThrottle < speedControl.minThrottle) {
		gba.throttle = speedControl.minThrottle;
		speedControl.framesPerIteration = Math.ceil(speedControl.minThrottle / targetThrottle);
	} else {
		gba.throttle = targetThrottle;
		speedControl.framesPerIteration = 1;
	}
}

function updateSpeedUI() {
	var speedButtons = document.querySelectorAll('.speed-btn');
	speedButtons.forEach(function(btn) {
		var btnSpeed = parseFloat(btn.getAttribute('data-speed'));
		if (btnSpeed === speedControl.currentSpeed) {
			btn.classList.add('active');
		} else {
			btn.classList.remove('active');
		}
	});
	
	var speedDisplay = document.getElementById('speed-display');
	if (speedDisplay) {
		var displaySpeed = speedControl.turboActive ? speedControl.turboSpeed : speedControl.currentSpeed;
		speedDisplay.textContent = displaySpeed + 'x';
	}
}

function activateTurbo() {
	if (!speedControl.turboActive) {
		speedControl.turboActive = true;
		updateThrottle();
		updateSpeedUI();
	}
}

function deactivateTurbo() {
	if (speedControl.turboActive) {
		speedControl.turboActive = false;
		updateThrottle();
		updateSpeedUI();
	}
}

function handleTurboKey(e) {
	if (controlRemapping.listening) return;
	
	if (e.keyCode === 9) {
		e.preventDefault();
		if (e.type === 'keydown' && !speedControl.turboActive) {
			activateTurbo();
		} else if (e.type === 'keyup') {
			deactivateTurbo();
		}
	}
}

function saveSpeedPreference() {
	localStorage.setItem('gbaGameSpeed', speedControl.currentSpeed.toString());
}

function loadSpeedPreference() {
	var savedSpeed = localStorage.getItem('gbaGameSpeed');
	if (savedSpeed) {
		var speed = parseFloat(savedSpeed);
		if ([0.5, 1, 2, 5, 10].indexOf(speed) !== -1) {
			setGameSpeed(speed);
		}
	}
}

function lcdFade(context, target, callback) {
	var i = 0;
	var drawInterval = setInterval(function() {
		i++;
		var pixelData = context.getImageData(0, 0, 240, 160);
		for (var y = 0; y < 160; ++y) {
			for (var x = 0; x < 240; ++x) {
				var xDiff = Math.abs(x - 120);
				var yDiff = Math.abs(y - 80) * 0.8;
				var xFactor = (120 - i - xDiff) / 120;
				var yFactor = (80 - i - ((y & 1) * 10) - yDiff + Math.pow(xDiff, 1 / 2)) / 80;
				pixelData.data[(x + y * 240) * 4 + 3] *= Math.pow(xFactor, 1 / 3) * Math.pow(yFactor, 1 / 2);
			}
		}
		context.putImageData(pixelData, 0, 0);
		target.clearRect(0, 0, 480, 320);
		if (i > 40) {
			clearInterval(drawInterval);
		} else {
			callback();
		}
	}, 50);
}

function setVolume(value) {
	gba.audio.masterVolume = Math.pow(2, value) - 1;
}

function setPixelated(pixelated) {
	var screen = document.getElementById('screen');
	var context = screen.getContext('2d');
	if (context.webkitImageSmoothingEnabled) {
		context.webkitImageSmoothingEnabled = !pixelated;
	} else if (context.mozImageSmoothingEnabled) {
		context.mozImageSmoothingEnabled = !pixelated;
	} else if (window.navigator.appName != 'Microsoft Internet Explorer') {
			if (pixelated) {
				screen.setAttribute('width', '240');
				screen.setAttribute('height', '160');
			} else {
				screen.setAttribute('width', '480');
				screen.setAttribute('height', '320');
			}
			if (window.navigator.appName == 'Opera') {
			if (pixelated) {
				screen.style.marginTop = '0';
				screen.style.marginBottom = '-325px';
			} else {
				delete screen.style;
			}
		}
	}
}

function enableDebug() {
	window.onmessage = function(message) {
		if (message.origin != document.domain && (message.origin != 'file://' || document.domain)) {
			console.log('Failed XSS');
			return;
		}
		switch (message.data) {
		case 'connect':
			if (message.source == debug) {
				debug.postMessage('connect', document.domain || '*');
			}
			break;
		case 'connected':
			break;
		case 'disconnect':
			if (message.source == debug) {
				debug = null;
			}
		}
	}
	window.onunload = function() {
		if (debug && debug.postMessage) {
			debug.postMessage('disconnect', document.domain || '*');
		}
	}

}

document.addEventListener('webkitfullscreenchange', function() {
	var canvas = document.getElementById('screen');
	if (document.webkitIsFullScreen) {
		canvas.setAttribute('height', document.body.offsetHeight);
		canvas.setAttribute('width', document.body.offsetHeight / 2 * 3);
		canvas.setAttribute('style', 'margin: 0');
	} else {
		canvas.setAttribute('height', 320);
		canvas.setAttribute('width', 480);
		canvas.removeAttribute('style');
	}
}, false);

function initTouchControls() {
	var keyMapping = {
		'UP': gba.keypad.KEYCODE_UP,
		'DOWN': gba.keypad.KEYCODE_DOWN,
		'LEFT': gba.keypad.KEYCODE_LEFT,
		'RIGHT': gba.keypad.KEYCODE_RIGHT,
		'A': gba.keypad.KEYCODE_A,
		'B': gba.keypad.KEYCODE_B,
		'L': gba.keypad.KEYCODE_L,
		'R': gba.keypad.KEYCODE_R,
		'START': gba.keypad.KEYCODE_START,
		'SELECT': gba.keypad.KEYCODE_SELECT
	};
	
	var touchButtons = document.querySelectorAll('#touch-controls button');
	
	touchButtons.forEach(function(button) {
		var key = button.getAttribute('data-key');
		var keyCode = keyMapping[key];
		
		if (keyCode) {
			button.addEventListener('touchstart', function(e) {
				e.preventDefault();
				if (gba && gba.keypad) {
					gba.keypad.keyboardHandler({keyCode: keyCode, type: 'keydown', preventDefault: function(){}});
				}
			});
			
			button.addEventListener('touchend', function(e) {
				e.preventDefault();
				if (gba && gba.keypad) {
					gba.keypad.keyboardHandler({keyCode: keyCode, type: 'keyup', preventDefault: function(){}});
				}
			});
			
			button.addEventListener('touchcancel', function(e) {
				e.preventDefault();
				if (gba && gba.keypad) {
					gba.keypad.keyboardHandler({keyCode: keyCode, type: 'keyup', preventDefault: function(){}});
				}
			});
		}
	});
}

window.addEventListener('load', function() {
	initTouchControls();
});

function toggleSettingsMenu() {
	var menu = document.getElementById('settings-menu');
	menu.classList.toggle('show');
}

function openModal(modalId) {
	var modal = document.getElementById(modalId);
	modal.style.display = 'flex';
	document.getElementById('settings-menu').classList.remove('show');
	document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
	var modal = document.getElementById(modalId);
	modal.style.display = 'none';
	document.body.style.overflow = 'auto';
}

window.onclick = function(event) {
	var settingsMenu = document.getElementById('settings-menu');
	var settingsFab = document.getElementById('settings-fab');
	
	if (!settingsFab.contains(event.target) && !settingsMenu.contains(event.target)) {
		settingsMenu.classList.remove('show');
	}
	
	if (event.target.classList.contains('modal')) {
		event.target.style.display = 'none';
		document.body.style.overflow = 'auto';
	}
}
</script>
</head>
<body>
<header>
	<h1>Game Boy Advance Emulator</h1>
	<p>by Gustavo Queiroz</p>
</header>

<button id="settings-fab" onclick="toggleSettingsMenu()">
	<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
		<circle cx="12" cy="12" r="3"></circle>
		<path d="M12 1v6m0 6v6m9-9h-6m-6 0H3m15.364 6.364l-4.243-4.243m-6 0L3.879 20.12m16.242 0l-4.243-4.243m-6 0l-4.242 4.243"></path>
	</svg>
</button>

<div id="settings-menu" class="settings-dropdown">
	<button class="settings-option" onclick="openModal('controls-modal')">
		<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<rect x="2" y="7" width="20" height="10" rx="2"></rect>
			<circle cx="7" cy="12" r="1"></circle>
			<path d="M16 9h2m-2 6h2"></path>
		</svg>
		Keyboard Controls
	</button>
	<button class="settings-option" onclick="openModal('theme-modal')">
		<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path>
		</svg>
		Themes & Layout
	</button>
</div>

<div id="controls-modal" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h3>Keyboard Controls</h3>
			<button class="modal-close" onclick="closeModal('controls-modal')">&times;</button>
		</div>
		<div class="modal-body">
			<button id="reset-controls-btn" onclick="resetControlsToDefault()" style="margin-bottom: 16px;">Reset to Default</button>
			<div class="controls-grid">
			<div class="control-item remappable" data-action="UP" onclick="remapControl(this)">
				<div class="control-label">D-Pad Up</div>
				<div class="control-key" id="key-UP">↑</div>
				<div class="control-hint">Click to change</div>
			</div>
			<div class="control-item remappable" data-action="DOWN" onclick="remapControl(this)">
				<div class="control-label">D-Pad Down</div>
				<div class="control-key" id="key-DOWN">↓</div>
				<div class="control-hint">Click to change</div>
			</div>
			<div class="control-item remappable" data-action="LEFT" onclick="remapControl(this)">
				<div class="control-label">D-Pad Left</div>
				<div class="control-key" id="key-LEFT">←</div>
				<div class="control-hint">Click to change</div>
			</div>
			<div class="control-item remappable" data-action="RIGHT" onclick="remapControl(this)">
				<div class="control-label">D-Pad Right</div>
				<div class="control-key" id="key-RIGHT">→</div>
				<div class="control-hint">Click to change</div>
			</div>
			<div class="control-item remappable" data-action="A" onclick="remapControl(this)">
				<div class="control-label">Button A</div>
				<div class="control-key" id="key-A">X</div>
				<div class="control-hint">Click to change</div>
			</div>
			<div class="control-item remappable" data-action="B" onclick="remapControl(this)">
				<div class="control-label">Button B</div>
				<div class="control-key" id="key-B">Z</div>
				<div class="control-hint">Click to change</div>
			</div>
			<div class="control-item remappable" data-action="L" onclick="remapControl(this)">
				<div class="control-label">L Button</div>
				<div class="control-key" id="key-L">A</div>
				<div class="control-hint">Click to change</div>
			</div>
			<div class="control-item remappable" data-action="R" onclick="remapControl(this)">
				<div class="control-label">R Button</div>
				<div class="control-key" id="key-R">S</div>
				<div class="control-hint">Click to change</div>
			</div>
			<div class="control-item remappable" data-action="START" onclick="remapControl(this)">
				<div class="control-label">Start</div>
				<div class="control-key" id="key-START">Enter</div>
				<div class="control-hint">Click to change</div>
			</div>
			<div class="control-item remappable" data-action="SELECT" onclick="remapControl(this)">
				<div class="control-label">Select</div>
				<div class="control-key" id="key-SELECT">\</div>
				<div class="control-hint">Click to change</div>
			</div>
		</div>
		</div>
	</div>
</div>

<div id="main-container">
	<div id="game-area">
		<div id="screen-container">
			<canvas id="screen" width="480" height="320"></canvas>
			<div id="performance-monitor">
				<h4>Performance Monitor</h4>
				<div class="perf-grid">
					<div class="perf-item">
						<span class="perf-label">FPS</span>
						<span class="perf-value" id="fps-value">--</span>
					</div>
					<div class="perf-item">
						<span class="perf-label">Speed</span>
						<span class="perf-value" id="speed-value">--</span>
					</div>
					<div class="perf-item">
						<span class="perf-label">Memory</span>
						<span class="perf-value" id="memory-value">--</span>
					</div>
					<div class="perf-item">
						<span class="perf-label">Session</span>
						<span class="perf-value" id="time-value">00:00:00</span>
					</div>
				</div>
			</div>
		</div>
		
		<div id="touch-controls">
			<div id="dpad">
				<button class="dpad-btn" id="btn-up" data-key="UP">↑</button>
				<button class="dpad-btn" id="btn-left" data-key="LEFT">←</button>
				<button class="dpad-btn" id="btn-right" data-key="RIGHT">→</button>
				<button class="dpad-btn" id="btn-down" data-key="DOWN">↓</button>
				<div class="dpad-center"></div>
			</div>
			
			<div id="action-buttons">
				<button class="action-btn" id="btn-b" data-key="B">B</button>
				<button class="action-btn" id="btn-a" data-key="A">A</button>
			</div>
			
			<div id="shoulder-buttons">
				<button class="shoulder-btn" id="btn-l" data-key="L">L</button>
				<button class="shoulder-btn" id="btn-r" data-key="R">R</button>
			</div>
			
			<div id="menu-buttons">
				<button class="menu-btn" id="btn-select" data-key="SELECT">SELECT</button>
				<button class="menu-btn" id="btn-start" data-key="START">START</button>
			</div>
		</div>
		
		<section id="controls">
	<div id="preload">
		<button class="bigbutton" id="select" onclick="document.getElementById('loader').click()">Select ROM</button>
		<input id="loader" type="file" accept=".gba" onchange="run(this.files[0]);">
		<button onclick="document.getElementById('saveloader').click()">Upload Savegame</button>
		<input id="saveloader" type="file" onchange="uploadSavedataPending(this.files[0]);">
	</div>
	<div id="ingame" class="hidden">
		<button id="pause" class="bigbutton" onclick="togglePause()">PAUSE</button>
		<button onclick="gba.downloadSavedata()">Download Save</button>
		<button onclick="toggleFullscreen()">Fullscreen</button>
		<div id="sound">
			<input type="checkbox" checked onchange="gba.audio.masterEnable = this.checked">
			<p>Sound</p>
			<input type="range" min="0" max="1" value="1" step="any" onchange="setVolume(this.value)" oninput="setVolume(this.value)">
		</div>
		<div id="speed-control">
			<div class="speed-header">
				<span class="speed-label">Game Speed</span>
				<span class="speed-display" id="speed-display">1x</span>
			</div>
			<div class="speed-buttons">
				<button class="speed-btn" data-speed="0.5" onclick="setGameSpeed(0.5)">0.5x</button>
				<button class="speed-btn active" data-speed="1" onclick="setGameSpeed(1)">1x</button>
				<button class="speed-btn" data-speed="2" onclick="setGameSpeed(2)">2x</button>
				<button class="speed-btn" data-speed="5" onclick="setGameSpeed(5)">5x</button>
				<button class="speed-btn" data-speed="10" onclick="setGameSpeed(10)">10x</button>
			</div>
			<div class="turbo-hint">Hold Tab for 20x turbo</div>
		</div>
	</div>
</section>
	</div>
</div>

<div id="theme-modal" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h3>Themes & Layout</h3>
			<button class="modal-close" onclick="closeModal('theme-modal')">&times;</button>
		</div>
		<div class="modal-body">
			<div id="theme-control">
				<div class="theme-header">Themes</div>
				<div class="theme-buttons">
					<button class="theme-btn" data-theme="purple" onclick="applyTheme('purple')">Purple</button>
					<button class="theme-btn active" data-theme="dark" onclick="applyTheme('dark')">Dark</button>
					<button class="theme-btn" data-theme="light" onclick="applyTheme('light')">Light</button>
					<button class="theme-btn" data-theme="dracula" onclick="applyTheme('dracula')">Dracula</button>
					<button class="theme-btn" data-theme="ocean" onclick="applyTheme('ocean')">Ocean</button>
					<button class="theme-btn" data-theme="sunset" onclick="applyTheme('sunset')">Sunset</button>
				</div>
			</div>
			<div id="layout-control">
				<div class="layout-header">Layout</div>
				<div class="layout-buttons">
					<button class="layout-btn active" data-layout="default" onclick="applyLayout('default')">Default</button>
					<button class="layout-btn" data-layout="vertical" onclick="applyLayout('vertical')">Vertical</button>
					<button class="layout-btn" data-layout="compact" onclick="applyLayout('compact')">Compact</button>
				</div>
			</div>
			<div id="custom-control">
				<div class="custom-header">Background</div>
				<div class="custom-buttons">
					<button onclick="uploadBackground()">Upload Image</button>
					<button onclick="clearBackground()">Clear Image</button>
				</div>
			</div>
		</div>
	</div>
</div>

</body>
</html>
